<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Calculadora de Presupuestos de Perniles - Perniles del T√≠o Rudy</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #d4a574 0%, #8b5a3c 100%);
            min-height: 100vh;
            padding: 20px 0;
        }

        header {
            background: linear-gradient(135deg, #2a1810 0%, #5c3a1e 100%);
            color: white;
            text-align: center;
            padding: 30px 20px;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.3);
        }

        .header-content {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 20px;
            flex-wrap: wrap;
        }

        .logo-container {
            width: 120px;
            height: 120px;
            border-radius: 50%;
            overflow: hidden;
            box-shadow: 0 8px 20px rgba(0, 0, 0, 0.4);
            border: 4px solid #d4a574;
            background: white;
        }

        .logo-container img {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }

        header h1 {
            font-size: 2.5em;
            text-shadow: 2px 2px 4px rgba(0, 0, 0, 0.3);
            margin-bottom: 10px;
            color: white;
        }

        header p {
            font-size: 1.1em;
            opacity: 0.9;
        }

        .container {
            max-width: 800px;
            margin: 40px auto;
            background: white;
            padding: 40px;
            border-radius: 20px;
            box-shadow: 0 10px 40px rgba(0, 0, 0, 0.2);
        }

        h1 {
            text-align: center;
            color: #2a1810;
            margin-bottom: 30px;
            font-size: 2em;
        }

        .form-section {
            background: #f8f9fa;
            padding: 25px;
            border-radius: 15px;
            margin-bottom: 25px;
            border-left: 5px solid #d4a574;
        }

        .form-section h3 {
            color: #2a1810;
            margin-bottom: 20px;
            font-size: 1.3em;
            display: flex;
            align-items: center;
        }

        .form-section h3::before {
            content: "üìã";
            margin-right: 10px;
            font-size: 1.2em;
        }

        label {
            display: block;
            margin-top: 15px;
            margin-bottom: 8px;
            font-weight: 600;
            color: #333;
            font-size: 0.95em;
        }

        input[type="number"], 
        select, 
        input[type="text"], 
        input[type="datetime-local"], 
        textarea {
            width: 100%;
            padding: 12px 15px;
            margin-top: 5px;
            border: 2px solid #e0e0e0;
            border-radius: 10px;
            font-size: 1em;
            transition: all 0.3s ease;
            background: white;
        }

        input:focus, select:focus, textarea:focus {
            outline: none;
            border-color: #d4a574;
            box-shadow: 0 0 0 3px rgba(212, 165, 116, 0.2);
        }

        input.invalid, textarea.invalid {
            border-color: #e74c3c;
            background: #fff5f5;
        }

        button {
            display: block;
            width: 100%;
            padding: 18px;
            background: linear-gradient(135deg, #d4a574 0%, #8b5a3c 100%);
            color: white;
            border: none;
            border-radius: 12px;
            margin-top: 30px;
            cursor: not-allowed;
            font-size: 1.2em;
            font-weight: bold;
            transition: all 0.3s ease;
            opacity: 0.6;
        }

        button.enabled {
            cursor: pointer;
            opacity: 1;
        }

        button.enabled:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 20px rgba(212, 165, 116, 0.4);
        }

        button.loading {
            opacity: 0.7;
            cursor: wait;
            position: relative;
        }

        button.loading::after {
            content: "";
            position: absolute;
            width: 20px;
            height: 20px;
            top: 50%;
            left: 20px;
            margin-top: -10px;
            border: 3px solid rgba(255, 255, 255, 0.3);
            border-radius: 50%;
            border-top-color: #fff;
            animation: spinner 0.8s ease infinite;
        }

        @keyframes spinner {
            to { transform: rotate(360deg); }
        }

        .loading-overlay {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.7);
            z-index: 9998;
            justify-content: center;
            align-items: center;
        }

        .loading-overlay.active {
            display: flex;
        }

        .loading-content {
            background: white;
            padding: 40px;
            border-radius: 15px;
            text-align: center;
            box-shadow: 0 10px 40px rgba(0, 0, 0, 0.3);
        }

        .spinner {
            border: 5px solid #f3f3f3;
            border-top: 5px solid #d4a574;
            border-radius: 50%;
            width: 60px;
            height: 60px;
            animation: spin 1s linear infinite;
            margin: 0 auto 20px;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .loading-content h3 {
            color: #2a1810;
            margin-bottom: 10px;
            font-size: 1.3em;
        }

        .loading-content p {
            color: #666;
            font-size: 1em;
        }

        .result {
            margin-top: 30px;
            padding: 30px;
            background: linear-gradient(135deg, #e8a04e 0%, #d68438 100%);
            border-radius: 15px;
            color: white;
            box-shadow: 0 8px 25px rgba(0, 0, 0, 0.2);
        }

        .result p {
            margin: 12px 0;
            font-size: 1.05em;
            line-height: 1.6;
        }

        .result strong {
            font-weight: 700;
        }

        .whatsapp-button {
            margin-top: 20px;
            display: block;
            width: 100%;
            padding: 18px;
            background: linear-gradient(135deg, #25D366 0%, #128C7E 100%);
            color: white;
            text-align: center;
            text-decoration: none;
            border: none;
            border-radius: 12px;
            font-size: 1.2em;
            font-weight: bold;
            cursor: not-allowed;
            transition: all 0.3s ease;
            opacity: 0.6;
        }

        .whatsapp-button::before {
            content: "üì± ";
            font-size: 1.2em;
        }

        .whatsapp-button.enabled {
            cursor: pointer;
            opacity: 1;
        }

        .whatsapp-button.enabled:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 20px rgba(37, 211, 102, 0.4);
        }

        .whatsapp-button.loading {
            opacity: 0.7;
            cursor: wait;
        }

        footer {
            background: linear-gradient(135deg, #2a1810 0%, #5c3a1e 100%);
            color: white;
            text-align: center;
            padding: 25px;
            margin-top: 40px;
            box-shadow: 0 -4px 15px rgba(0, 0, 0, 0.3);
        }

        footer p {
            font-size: 1em;
        }

        #seleccionSalsas {
            margin-top: 20px;
            padding: 20px;
            background: white;
            border: 2px solid #d4a574;
            border-radius: 12px;
        }

        #seleccionSalsas > label {
            color: #d4a574;
            font-weight: bold;
            font-size: 1.1em;
            margin-bottom: 15px;
        }

        .salsa-item {
            margin: 15px 0;
            padding: 12px;
            background: #f8f9fa;
            border-radius: 8px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            transition: all 0.3s ease;
        }

        .salsa-item:hover {
            background: #e9ecef;
            transform: translateX(5px);
        }

        .salsa-item label {
            margin: 0;
            font-weight: 600;
            color: #495057;
        }

        .salsa-qty {
            width: 80px;
            padding: 8px;
            border: 2px solid #dee2e6;
            border-radius: 8px;
        }

        #errorSalsas {
            color: #e74c3c;
            display: none;
            margin-top: 10px;
            padding: 10px;
            background: #fee;
            border-radius: 8px;
            font-weight: bold;
        }

        .nota-importante {
            text-align: center;
            margin-top: 30px;
            padding: 20px;
            background: #fff3cd;
            border: 2px solid #ffc107;
            border-radius: 12px;
            color: #856404;
            font-weight: 600;
            font-size: 1.05em;
        }

        .gracias {
            text-align: center;
            margin-top: 20px;
            padding: 25px;
            background: linear-gradient(135deg, #d4a574 0%, #8b5a3c 100%);
            color: white;
            border-radius: 12px;
            font-size: 1.3em;
            font-weight: bold;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.2);
        }

        /* Modal de Vacaciones */
        #modalVacaciones {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.85);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 9999;
        }

        .modal-content {
            background-color: #fff;
            padding: 40px;
            border-radius: 15px;
            box-shadow: 0 10px 40px rgba(0, 0, 0, 0.3);
            text-align: center;
            max-width: 500px;
            width: 90%;
            border: 5px solid #dc3545;
            animation: slideDown 0.5s ease-out;
        }

        @keyframes slideDown {
            from {
                transform: translateY(-100px);
                opacity: 0;
            }
            to {
                transform: translateY(0);
                opacity: 1;
            }
        }

        .modal-content h2 {
            color: #dc3545;
            font-size: 28px;
            margin-bottom: 20px;
            text-transform: uppercase;
            font-weight: bold;
        }

        .modal-content p {
            font-size: 18px;
            line-height: 1.6;
            margin-bottom: 30px;
            color: #333;
        }

        .modal-content .fecha-importante {
            background-color: #fff3cd;
            padding: 15px;
            border-radius: 8px;
            border: 2px solid #ffc107;
            margin: 20px 0;
            font-weight: bold;
            color: #856404;
        }

        #btnAceptar {
            background-color: #28a745;
            color: white;
            padding: 15px 40px;
            font-size: 18px;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-weight: bold;
            transition: all 0.3s ease;
        }

        #btnAceptar:hover {
            background-color: #218838;
            transform: scale(1.05);
        }

        .ocultar {
            display: none !important;
        }

        /* Responsive */
        @media (max-width: 768px) {
            .container {
                padding: 25px;
                margin: 20px 10px;
            }

            header h1 {
                font-size: 1.8em;
            }

            h1 {
                font-size: 1.5em;
            }

            .logo-container {
                width: 90px;
                height: 90px;
            }
        }
    </style>
</head>
<body>
    <!-- Modal de Vacaciones -->
    <div id="modalVacaciones">
        <div class="modal-content">
            <h2>‚ö†Ô∏è AVISO IMPORTANTE ‚ö†Ô∏è</h2>
            <p><strong>ESTIMADOS CLIENTES:</strong></p>
            <div class="fecha-importante">
                DESDE EL 01/01/2026 AL 15/01/2026<br>
                VAMOS A ESTAR CERRADOS POR VACACIONES
            </div>
            <p>CUALQUIER SOLICITUD DE PRESUPUESTO, ES A PARTIR DEL <strong>VIERNES 16-01-2026</strong></p>
            <p style="font-size: 20px; margin-top: 20px;">¬°GRACIAS!</p>
            <button id="btnAceptar">ACEPTAR Y CONTINUAR</button>
        </div>
    </div>

    <!-- Loading Overlay -->
    <div id="loadingOverlay" class="loading-overlay">
        <div class="loading-content">
            <div class="spinner"></div>
            <h3>‚è≥ Enviando a WhatsApp...</h3>
            <p>Guardando presupuesto en el sistema</p>
            <p style="margin-top: 10px; font-size: 0.9em; color: #999;">Por favor espere un momento</p>
        </div>
    </div>

    <header>
        <div class="header-content">
            <div class="logo-container">
                <img src="logo.png" alt="Logo Perniles del T√≠o Rudy">
            </div>
            <div>
                <h1>üçñ Perniles del T√≠o Rudy üçñ</h1>
                <p>La mejor calidad para tu evento especial</p>
            </div>
        </div>
    </header>

    <main class="container">
        <h1>Calculadora de Presupuestos</h1>

        <div class="form-section">
            <h3>Datos del Cliente</h3>
            <label for="nombre">Nombre completo:</label>
            <input type="text" id="nombre" class="required" placeholder="Ingrese su nombre">
            
            <label for="telefono">N√∫mero de Tel√©fono:</label>
            <input type="text" id="telefono" class="required" placeholder="Ej: 2994520532">
        </div>

        <div class="form-section">
            <h3>Detalles del Pernil</h3>
            <label for="personas">Cantidad de personas:</label>
            <input type="number" id="personas" min="10" oninput="actualizarOpciones()" class="required" placeholder="M√≠nimo 10 personas">
            
            <label for="tipo">Tipo de pernil:</label>
            <select id="tipo">
                <option value="vacuno">Vacuno</option>
                <option value="cerdo">Cerdo</option>
                <option value="mixto">Mixto</option>
            </select>

            <label for="salsas">Cantidad de salsas incluidas:</label>
            <input type="number" id="salsas" min="0" value="0" readonly>

            <div id="seleccionSalsas" style="display: none;">
                <label>Seleccione las salsas (m√°ximo: <span id="maxSalsas">0</span>):</label>
                
                <div class="salsa-item">
                    <label>Cuatro Quesos:</label>
                    <input type="number" class="salsa-qty" min="0" value="0" data-salsa="Cuatro Quesos">
                </div>
                <div class="salsa-item">
                    <label>Provenzal:</label>
                    <input type="number" class="salsa-qty" min="0" value="0" data-salsa="Provenzal">
                </div>
                <div class="salsa-item">
                    <label>T√°rtara:</label>
                    <input type="number" class="salsa-qty" min="0" value="0" data-salsa="Tartara">
                </div>
                <div class="salsa-item">
                    <label>Aceitunas:</label>
                    <input type="number" class="salsa-qty" min="0" value="0" data-salsa="Aceitunas">
                </div>
                <div class="salsa-item">
                    <label>Criolla:</label>
                    <input type="number" class="salsa-qty" min="0" value="0" data-salsa="Criolla">
                </div>
                <div class="salsa-item">
                    <label>Berenjenas:</label>
                    <input type="number" class="salsa-qty" min="0" value="0" data-salsa="Berenjenas">
                </div>
                <div class="salsa-item">
                    <label>Prov. con Verdeo:</label>
                    <input type="number" class="salsa-qty" min="0" value="0" data-salsa="Prov. con Verdeo">
                </div>
                <p id="errorSalsas">¬°No puede exceder la cantidad total de salsas!</p>
            </div>
        </div>

        <div class="form-section">
            <h3>Servicios Adicionales</h3>
            <label for="envio">Opci√≥n de env√≠o:</label>
            <select id="envio" onchange="mostrarDatosEvento()">
                <option value="0">Ninguno - Retiro en local</option>
                <option value="10000">Env√≠o a domicilio Neuqu√©n Capital hasta 3 km ($10.000)</option>
                <option value="25000">Env√≠o a domicilio Alrededores ($25.000)</option>
            </select>
            
            <label for="mozo">Servicio de mozo de corte:</label>
            <select id="mozo" onchange="mostrarDatosEvento()">
                <option value="0">Ninguno</option>
                <option value="50000">Mozo de corte en Neuqu√©n Capital</option>
                <option value="70000">Mozo de corte en Alrededores</option>
            </select>

            <div id="datosEvento">
                <label for="direccion">Direcci√≥n del evento:</label>
                <input type="text" id="direccion" class="required-event" placeholder="Calle, n√∫mero, localidad">
                
                <label for="fechaHora">Fecha y hora del evento:</label>
                <input type="datetime-local" id="fechaHora" class="required-event">
            </div>
        </div>

        <div class="form-section">
            <h3>Empanadas (Opcional)</h3>
            <label for="empanadasCarne">Empanadas de carne (unidad - $2.000 c/u):</label>
            <input type="number" id="empanadasCarne" min="0" value="0" placeholder="0">
            
            <label for="empanadasJamonQueso">Empanadas de jam√≥n y queso (unidad - $2.000 c/u):</label>
            <input type="number" id="empanadasJamonQueso" min="0" value="0" placeholder="0">
            
            <label for="empanadasChoclo">Empanadas de choclo (unidad - $2.000 c/u):</label>
            <input type="number" id="empanadasChoclo" min="0" value="0" placeholder="0">

            <label for="empanadasVerdura">Empanadas de verdura (unidad - $2.000 c/u):</label>
            <input type="number" id="empanadasVerdura" min="0" value="0" placeholder="0">
        </div>

        <div class="form-section">
            <h3>Tablas de Fiambre (Opcional)</h3>
            <label for="tablasChicas">Tablas de fiambre Chica - 5 personas ($50.000):</label>
            <input type="number" id="tablasChicas" min="0" value="0" placeholder="0">
            
            <label for="tablasMedianas">Tablas de fiambre Mediana - 10 personas ($95.000):</label>
            <input type="number" id="tablasMedianas" min="0" value="0" placeholder="0">
            
            <label for="tablasGrandes">Tablas de fiambre Grande - 15 personas ($140.000):</label>
            <input type="number" id="tablasGrandes" min="0" value="0" placeholder="0">
        </div>

        <div class="form-section">
            <h3>Observaciones</h3>
            <label for="observaciones">Comentarios adicionales:</label>
            <textarea id="observaciones" rows="4" placeholder="Ingrese aqu√≠ cualquier observaci√≥n o comentario adicional..."></textarea>
        </div>

        <button id="calcularButton" onclick="calcularPresupuesto()" disabled>Calcular Presupuesto</button>
        
        <div class="result" id="resultado"></div>

        <a id="whatsapp-link" class="whatsapp-button" href="#" target="_blank" style="display: none;">Enviar presupuesto por WhatsApp</a>

        <div class="nota-importante">
            ‚ö†Ô∏è Nota Importante: El pernil no va fileteado, es por ello que se ofrece la opci√≥n de mozo de corte
        </div>

        <div class="gracias">
            ‚ù§Ô∏è GRACIAS POR ELEGIR A PERNILES DEL T√çO RUDY ‚ù§Ô∏è
        </div>
    </main>

    <footer>
        <p>&copy; 2024 Perniles del T√≠o Rudy. Todos los derechos reservados.</p>
    </footer>
    
    <script>
        // ‚ö†Ô∏è CONFIGURACI√ìN IMPORTANTE: Reemplaza esta URL con la de tu Google Apps Script
        const GOOGLE_SCRIPT_URL = 'https://script.google.com/macros/s/AKfycbxpcZx5CXLe5_ymXUMlFjwpDGNjIXZfkHtj1uYcA0dTqAXya04bNYe6PcsJkjK5XmmwQw/exec';
        
        // Variable global para almacenar los datos del presupuesto
        let datosPresupuestoActual = null;
        
        // Funcionalidad del modal
        document.getElementById('btnAceptar').addEventListener('click', function() {
            document.getElementById('modalVacaciones').classList.add('ocultar');
        });

        // Funci√≥n para enviar datos a Google Sheets
        async function enviarAGoogleSheets(datos) {
            try {
                const response = await fetch(GOOGLE_SCRIPT_URL, {
                    method: 'POST',
                    mode: 'no-cors',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify(datos)
                });
                
                console.log('‚úÖ Datos enviados a Google Sheets correctamente');
                return true;
            } catch (error) {
                console.error('‚ùå Error al enviar a Google Sheets:', error);
                return false;
            }
        }

        // Funci√≥n para mostrar/ocultar loading
        function mostrarLoading(mostrar) {
            const overlay = document.getElementById('loadingOverlay');
            
            if (mostrar) {
                overlay.classList.add('active');
            } else {
                overlay.classList.remove('active');
            }
        }

        function actualizarOpciones() {
            const personas = parseInt(document.getElementById('personas').value);
            const tipoSelect = document.getElementById('tipo');
            const salsasInput = document.getElementById('salsas');
            const seleccionSalsasDiv = document.getElementById('seleccionSalsas');
            const maxSalsasSpan = document.getElementById('maxSalsas');

            // Actualizar tipo de pernil
            tipoSelect.innerHTML = '';
            if (personas < 20) {
                tipoSelect.innerHTML += '<option value="vacuno">Vacuno</option>';
                tipoSelect.innerHTML += '<option value="cerdo">Cerdo</option>';
            } else {
                tipoSelect.innerHTML += '<option value="vacuno">Vacuno</option>';
                tipoSelect.innerHTML += '<option value="cerdo">Cerdo</option>';
                tipoSelect.innerHTML += '<option value="mixto">Mixto</option>';
            }

            // Calcular cantidad de salsas
            const totalSalsas = Math.ceil((1/5) * personas) + 1;
            salsasInput.value = totalSalsas;
            maxSalsasSpan.textContent = totalSalsas;
            seleccionSalsasDiv.style.display = 'block';

            // Validaci√≥n corregida de salsas
            document.querySelectorAll('.salsa-qty').forEach(input => {
                input.addEventListener('input', function() {
                    const totalSalsas = parseInt(document.getElementById('salsas').value);
                    const currentSum = Array.from(document.querySelectorAll('.salsa-qty'))
                                          .reduce((sum, el) => sum + parseInt(el.value || 0), 0);
                    
                    if (currentSum > totalSalsas) {
                        document.getElementById('errorSalsas').style.display = 'block';
                        const remaining = totalSalsas - (currentSum - parseInt(this.value));
                        this.value = Math.max(0, Math.min(remaining, parseInt(this.value)));
                    } else {
                        document.getElementById('errorSalsas').style.display = 'none';
                    }
                });
            });

            validarDatos();
        }

        function mostrarDatosEvento() {
            validarDatos();
        }

        function validarDatos() {
            const camposValidos = [
                document.getElementById('nombre').value.trim(),
                document.getElementById('telefono').value.trim(),
                !isNaN(parseInt(document.getElementById('personas').value)) && parseInt(document.getElementById('personas').value) >= 10,
                document.getElementById('fechaHora').value,
                (parseInt(document.getElementById('envio').value) !== 0 || parseInt(document.getElementById('mozo').value) !== 0) ? 
                    document.getElementById('direccion').value.trim() : true
            ].every(Boolean);

            const calcularButton = document.getElementById('calcularButton');
            const whatsappButton = document.getElementById('whatsapp-link');

            calcularButton.disabled = !camposValidos;
            calcularButton.classList.toggle('enabled', camposValidos);
            whatsappButton.style.display = camposValidos ? 'block' : 'none';
            whatsappButton.classList.toggle('enabled', camposValidos);
        }

        function calcularPresupuesto() {
            const nombre = document.getElementById('nombre').value.trim();
            const telefono = document.getElementById('telefono').value.trim();
            const personas = parseInt(document.getElementById('personas').value);
            let envio = parseInt(document.getElementById('envio').value);
            let mozo = parseInt(document.getElementById('mozo').value);
            const tipo = document.getElementById('tipo').value;
            const salsasInput = parseInt(document.getElementById('salsas').value);
            const direccion = document.getElementById('direccion').value.trim();
            const fechaHora = document.getElementById('fechaHora').value;
            const observaciones = document.getElementById('observaciones').value.trim();
            const empanadasCarne = parseInt(document.getElementById('empanadasCarne').value) || 0;
            const empanadasJamonQueso = parseInt(document.getElementById('empanadasJamonQueso').value) || 0;
            const empanadasChoclo = parseInt(document.getElementById('empanadasChoclo').value) || 0;
            const empanadasVerdura = parseInt(document.getElementById('empanadasVerdura').value) || 0;
            const tablasChicas = parseInt(document.getElementById('tablasChicas').value) || 0;
            const tablasMedianas = parseInt(document.getElementById('tablasMedianas').value) || 0;
            const tablasGrandes = parseInt(document.getElementById('tablasGrandes').value) || 0;
            const mozoText = document.getElementById('mozo').options[document.getElementById('mozo').selectedIndex].text;

            // Validar salsas
            const salsas = {};
            let sumaSalsas = 0;
            document.querySelectorAll('.salsa-qty').forEach(input => {
                const salsaName = input.getAttribute('data-salsa');
                const qty = parseInt(input.value || 0);
                if (qty > 0) {
                    salsas[salsaName] = qty;
                    sumaSalsas += qty;
                }
            });

            if (sumaSalsas > salsasInput) {
                alert("¬°La suma de salsas supera el m√°ximo permitido!");
                return;
            }
            
            // C√°lculos
            const panesPorPersona = 4;
            
            // Determinar el precio del pernil seg√∫n la fecha del evento
            let costoPorPersona;
            const fechaEvento = new Date(fechaHora);
            const fechaLimite = new Date('2025-12-01T00:00:00');
            
            if (fechaEvento >= fechaLimite) {
                // Precios a partir del 01/12/2025
                costoPorPersona = personas < 20 ? 13000 : 12000;
            } else {
                // Precios antes del 01/12/2025
                costoPorPersona = personas < 20 ? 12000 : 11000;
            }
            
            const costoEmpanada = 2000;
            const costoTablasChicas = 50000;
            const costoTablasMedianas = 95000;
            const costoTablasGrandes = 140000;
            
            const totalPanes = panesPorPersona * personas;
            const totalCostoPersonas = costoPorPersona * personas;
            const totalEmpanadasCarne = empanadasCarne * costoEmpanada;
            const totalEmpanadasJamonQueso = empanadasJamonQueso * costoEmpanada;
            const totalEmpanadasChoclo = empanadasChoclo * costoEmpanada;
            const totalEmpanadasVerdura = empanadasVerdura * costoEmpanada;
            const totalTablasChicas = tablasChicas * costoTablasChicas;
            const totalTablasMedianas = tablasMedianas * costoTablasMedianas;
            const totalTablasGrandes = tablasGrandes * costoTablasGrandes;
            
            let mozos = 0;
            if (mozo !== 0) {
                mozos = Math.ceil(personas / 50);
    
                if (personas <= 39) {
                    mozo = 40000;
                } else if (personas > 39) {
                    mozo = 50000;
                }
    
                const mozoSelect = document.getElementById('mozo');
                const mozoValue = parseInt(mozoSelect.value);

                if (mozoValue === 70000) {
                    mozo = 70000;
                }

                mozo *= mozos;
                envio = 0;
            }

            const totalPresupuesto = totalCostoPersonas + 
                totalEmpanadasCarne + totalEmpanadasJamonQueso + totalEmpanadasChoclo + totalEmpanadasVerdura +
                totalTablasChicas + totalTablasMedianas + totalTablasGrandes + envio + mozo;

            // üî¥ GUARDAR los datos en la variable global pero NO enviar a Google Sheets a√∫n
            datosPresupuestoActual = {
                nombre: nombre,
                telefono: telefono,
                personas: personas,
                tipo: tipo.charAt(0).toUpperCase() + tipo.slice(1),
                salsas: Object.entries(salsas).map(([k, v]) => `${k} (${v})`).join(', ') || 'Ninguna',
                panes: totalPanes,
                costoPernil: totalCostoPersonas,
                empanadasCarne: empanadasCarne > 0 ? empanadasCarne : 0,
                empanadasJamonQueso: empanadasJamonQueso > 0 ? empanadasJamonQueso : 0,
                empanadasChoclo: empanadasChoclo > 0 ? empanadasChoclo : 0,
                empanadasVerdura: empanadasVerdura > 0 ? empanadasVerdura : 0,
                tablasChicas: tablasChicas > 0 ? tablasChicas : 0,
                tablasMedianas: tablasMedianas > 0 ? tablasMedianas : 0,
                tablasGrandes: tablasGrandes > 0 ? tablasGrandes : 0,
                envio: envio !== 0 ? envio : 0,
                mozo: mozo !== 0 ? mozo : 0,
                fechaEvento: fechaHora,
                direccion: (envio !== 0 || mozo !== 0) ? direccion : 'N/A',
                observaciones: observaciones || 'N/A',
                total: totalPresupuesto
            };

            // Mensaje WhatsApp
            let whatsappMessage = `*PRESUPUESTO PERNILES DEL T√çO RUDY*\n\n`;
            whatsappMessage += `*Nombre:* ${nombre}\n`;
            whatsappMessage += `*Tel√©fono:* ${telefono}\n`;
            whatsappMessage += `*Personas:* ${personas}\n`;
            whatsappMessage += `*Tipo de pernil:* ${tipo.charAt(0).toUpperCase() + tipo.slice(1)}\n`;
            whatsappMessage += `*Salsas:* ${Object.entries(salsas).map(([k, v]) => `${k} (${v})`).join(', ') || 'Ninguna'}\n`;
            whatsappMessage += `*Panes √°rabes:* ${totalPanes}\n`;
            whatsappMessage += `*Costo Pernil:* ${totalCostoPersonas.toLocaleString('es-AR')}\n`;

            if (empanadasCarne > 0 || empanadasJamonQueso > 0 || empanadasChoclo > 0 || empanadasVerdura > 0) {
                whatsappMessage += `\n*Empanadas:*\n`;
                if (empanadasCarne > 0) whatsappMessage += `- Carne: ${empanadasCarne} unid. (${totalEmpanadasCarne.toLocaleString('es-AR')})\n`;
                if (empanadasJamonQueso > 0) whatsappMessage += `- Jam√≥n/Queso: ${empanadasJamonQueso} unid. (${totalEmpanadasJamonQueso.toLocaleString('es-AR')})\n`;
                if (empanadasChoclo > 0) whatsappMessage += `- Choclo: ${empanadasChoclo} unid. (${totalEmpanadasChoclo.toLocaleString('es-AR')})\n`;
                if (empanadasVerdura > 0) whatsappMessage += `- Verdura: ${empanadasVerdura} unid. (${totalEmpanadasVerdura.toLocaleString('es-AR')})\n`;
            }

            if (tablasChicas > 0 || tablasMedianas > 0 || tablasGrandes > 0) {
                whatsappMessage += `\n*Tablas de fiambre:*\n`;
                if (tablasChicas > 0) whatsappMessage += `- Chica: ${tablasChicas} unid. (${totalTablasChicas.toLocaleString('es-AR')})\n`;
                if (tablasMedianas > 0) whatsappMessage += `- Mediana: ${tablasMedianas} unid. (${totalTablasMedianas.toLocaleString('es-AR')})\n`;
                if (tablasGrandes > 0) whatsappMessage += `- Grande: ${tablasGrandes} unid. (${totalTablasGrandes.toLocaleString('es-AR')})\n`;
            }

            whatsappMessage += `\n*Env√≠o:* ${envio !== 0 ? `${envio.toLocaleString('es-AR')}` : 'Ninguno'}\n`;
            if (mozo !== 0) whatsappMessage += `*Servicio de mozo:* ${mozoText} (${mozo.toLocaleString('es-AR')})\n`;
            whatsappMessage += `*Fecha y hora del evento:* ${fechaHora}\n`;
            if (envio !== 0 || mozo !== 0) whatsappMessage += `*Direcci√≥n:* ${direccion}\n`;
            if (observaciones) whatsappMessage += `\n*Observaciones:*\n${observaciones}\n`;
            whatsappMessage += `\n*TOTAL PRESUPUESTO:* ${totalPresupuesto.toLocaleString('es-AR')}\n\n`;
            whatsappMessage += `_Nota Importante: El pernil no va fileteado, es por ello que se ofrece la opci√≥n de mozo de corte - GRACIAS POR ELEGIR A PERNILES DEL T√çO RUDY_`;
                       
            // Actualizar resultados (sin mensaje de Google Sheets)
            document.getElementById('resultado').innerHTML = `
                <p><strong>Nombre:</strong> ${nombre}</p>
                <p><strong>Tel√©fono:</strong> ${telefono}</p>
                <p><strong>Personas:</strong> ${personas}</p>
                <p><strong>Tipo de pernil:</strong> ${tipo.charAt(0).toUpperCase() + tipo.slice(1)}</p>
                <p><strong>Salsas:</strong> ${Object.entries(salsas).map(([k, v]) => `${k} (${v})`).join(', ') || 'Ninguna'}</p>
                <p><strong>Panes √°rabes:</strong> ${totalPanes}</p>
                <p><strong>Costo Pernil:</strong> ${totalCostoPersonas.toLocaleString('es-AR')}</p>
                ${empanadasCarne > 0 ? `<p><strong>Empanadas de carne:</strong> ${totalEmpanadasCarne.toLocaleString('es-AR')}</p>` : ''}
                ${empanadasJamonQueso > 0 ? `<p><strong>Empanadas de jam√≥n y queso:</strong> ${totalEmpanadasJamonQueso.toLocaleString('es-AR')}</p>` : ''}
                ${empanadasChoclo > 0 ? `<p><strong>Empanadas de choclo:</strong> ${totalEmpanadasChoclo.toLocaleString('es-AR')}</p>` : ''}
                ${empanadasVerdura > 0 ? `<p><strong>Empanadas de verdura:</strong> ${totalEmpanadasVerdura.toLocaleString('es-AR')}</p>` : ''}
                ${tablasChicas > 0 ? `<p><strong>Tablas Chicas:</strong> ${totalTablasChicas.toLocaleString('es-AR')}</p>` : ''}
                ${tablasMedianas > 0 ? `<p><strong>Tablas Medianas:</strong> ${totalTablasMedianas.toLocaleString('es-AR')}</p>` : ''}
                ${tablasGrandes > 0 ? `<p><strong>Tablas Grandes:</strong> ${totalTablasGrandes.toLocaleString('es-AR')}</p>` : ''}
                ${envio !== 0 ? `<p><strong>Env√≠o:</strong> ${envio.toLocaleString('es-AR')}</p>` : ''}
                ${mozo !== 0 ? `<p><strong>Servicio de mozo:</strong> ${mozo.toLocaleString('es-AR')}</p>` : ''}
                <p><strong>Fecha y hora:</strong> ${fechaHora}</p>
                ${(envio !== 0 || mozo !== 0) ? `<p><strong>Direcci√≥n:</strong> ${direccion}</p>` : ''}
                ${observaciones ? `<p><strong>Observaciones:</strong> ${observaciones}</p>` : ''}
                <p style="font-size: 1.3em; margin-top: 20px; padding-top: 15px; border-top: 2px solid rgba(255,255,255,0.5);"><strong>TOTAL:</strong> ${totalPresupuesto.toLocaleString('es-AR')}</p>
            `;

            // Configurar el enlace de WhatsApp
            const whatsappLink = document.getElementById('whatsapp-link');
            const whatsappUrl = `https://wa.me/2994520532?text=${encodeURIComponent(whatsappMessage)}`;
            whatsappLink.href = '#'; // Usar # temporalmente para evitar navegaci√≥n directa
            
            // Remover cualquier evento anterior y agregar el nuevo
            whatsappLink.onclick = async function(e) {
                e.preventDefault(); // Prevenir comportamiento por defecto
                
                // IMPORTANTE: Abrir la ventana INMEDIATAMENTE (antes de operaciones as√≠ncronas)
                // para evitar que el navegador la bloquee
                const whatsappWindow = window.open('', '_blank');
                
                // Mostrar loading
                mostrarLoading(true);
                whatsappLink.classList.add('loading');
                whatsappLink.style.pointerEvents = 'none';
                whatsappLink.textContent = '‚è≥ Enviando...';
                
                try {
                    // Enviar a Google Sheets
                    const enviado = await enviarAGoogleSheets(datosPresupuestoActual);
                    
                    // Esperar un momento para que se vea el loading
                    await new Promise(resolve => setTimeout(resolve, 1000));
                    
                    // Ocultar loading
                    mostrarLoading(false);
                    whatsappLink.classList.remove('loading');
                    whatsappLink.style.pointerEvents = 'auto';
                    whatsappLink.innerHTML = 'üì± Enviar presupuesto por WhatsApp';
                    
                    if (enviado) {
                        // Mostrar mensaje de √©xito en el resultado
                        const resultDiv = document.getElementById('resultado');
                        let successMsg = resultDiv.querySelector('.success-message');
                        
                        if (!successMsg) {
                            successMsg = document.createElement('p');
                            successMsg.className = 'success-message';
                            successMsg.style.cssText = 'margin-top: 15px; padding: 10px; background: rgba(40, 167, 69, 0.2); border-radius: 8px; font-size: 1em; color: #28a745; font-weight: bold; text-align: center;';
                            resultDiv.appendChild(successMsg);
                        }
                        successMsg.innerHTML = '‚úÖ Presupuesto guardado exitosamente en el sistema';
                    } else {
                        console.warn('No se pudo guardar en Google Sheets, pero se proceder√° con WhatsApp');
                    }
                    
                    // Redirigir la ventana ya abierta a WhatsApp
                    if (whatsappWindow) {
                        whatsappWindow.location.href = whatsappUrl;
                    } else {
                        // Fallback: si por alguna raz√≥n la ventana no se abri√≥, intentar de nuevo
                        window.open(whatsappUrl, '_blank');
                    }
                    
                } catch (error) {
                    console.error('Error durante el proceso:', error);
                    
                    // Ocultar loading
                    mostrarLoading(false);
                    whatsappLink.classList.remove('loading');
                    whatsappLink.style.pointerEvents = 'auto';
                    whatsappLink.innerHTML = 'üì± Enviar presupuesto por WhatsApp';
                    
                    // Intentar abrir WhatsApp en la ventana ya creada
                    if (whatsappWindow) {
                        whatsappWindow.location.href = whatsappUrl;
                    } else if (confirm('‚ö†Ô∏è Hubo un problema al guardar en el sistema.\n¬øDesea enviar el presupuesto por WhatsApp de todas formas?')) {
                        window.open(whatsappUrl, '_blank');
                    }
                }
                
                return false; // Asegurar que no se siga el enlace
            };
        }

        // Event listeners
        document.getElementById('nombre').addEventListener('input', validarDatos);
        document.getElementById('telefono').addEventListener('input', validarDatos);
        document.getElementById('personas').addEventListener('input', validarDatos);
        document.getElementById('direccion').addEventListener('input', validarDatos);
        document.getElementById('fechaHora').addEventListener('input', validarDatos);
        document.getElementById('observaciones').addEventListener('input', validarDatos);
    </script>
</body>
</html>











